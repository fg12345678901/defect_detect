<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批量检测进度 - 表面缺陷检测系统</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <i class="fas fa-industry mr-2"></i>表面缺陷检测系统
      </a>
    </div>
  </nav>

  <div class="container py-5 text-center">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card fade-in">
          <div class="card-body py-5">
            <div class="mb-4">
              <i class="fas fa-cogs fa-4x text-primary mb-3"></i>
              <h1 class="mb-4">正在进行批量检测</h1>
              <p class="lead">系统正在处理您上传的图像，请稍候...</p>
            </div>

            <div class="progress-container my-5">
              <div class="progress" style="height: 30px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
              </div>
              <div class="mt-3 d-flex justify-content-between">
                <div>已处理: <span id="processed-count">0</span></div>
                <div>总图数: <span id="total-count">0</span></div>
              </div>
              <div class="mt-4">
                <div id="progress-message" class="text-muted">初始化中...</div>
              </div>
            </div>

            <div class="processing-animation">
              <div class="spinner-grow text-primary mx-1" role="status"></div>
              <div class="spinner-grow text-primary mx-1" role="status" style="animation-delay: 0.2s"></div>
              <div class="spinner-grow text-primary mx-1" role="status" style="animation-delay: 0.4s"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let intervalId = null;
    const progressMessages = [
      "正在读取图像数据...",
      "正在进行缺陷检测...",
      "正在生成可视化结果...",
      "正在分析检测结果...",
      "正在准备统计数据..."
    ];
    let messageIndex = 0;
    window.onload = function(){
      intervalId = setInterval(checkProgress, 1000);
      setInterval(updateProgressMessage, 3000);
    };
    function updateProgressMessage() {
      const messageElement = document.getElementById("progress-message");
      messageElement.textContent = progressMessages[messageIndex];
      messageIndex = (messageIndex + 1) % progressMessages.length;
    }
    function checkProgress(){
      fetch("{{ url_for('progress_status') }}")
        .then(res => res.json())
        .then(data => {
          const total = data.total;
          const processed = data.processed;
          const done = data.done;
          updateProgressBar(processed, total);
          document.getElementById("processed-count").textContent = processed;
          document.getElementById("total-count").textContent = total;
          if(done){
            clearInterval(intervalId);
            document.getElementById("progress-message").textContent = "处理完成，正在跳转到结果页面...";
            setTimeout(() => {
              window.location.href = "{{ result_url }}";
            }, 1000);
          }
        })
        .catch(err => console.log(err));
    }
    function updateProgressBar(processed, total){
      let percent = 0;
      if(total > 0){
        percent = Math.floor((processed / total) * 100);
      }
      const bar = document.querySelector(".progress-bar");
      bar.style.width = percent + "%";
      bar.setAttribute("aria-valuenow", percent);
      bar.textContent = percent + "%";
    }
  </script>
</body>
</html>
