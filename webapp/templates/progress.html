<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>检测进度 - 工业表面缺陷检测系统</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark gradient-navbar">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <i class="fas fa-microscope mr-2"></i>工业表面缺陷智能检测系统
      </a>
    </div>
  </nav>

  <!-- 主内容 -->
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-lg fade-in">
          <div class="card-body p-5">
            <!-- 图标和标题 -->
            <div class="text-center mb-5">
              <div class="progress-icon-container mb-4">
                <div class="progress-icon">
                  <i class="fas fa-cogs fa-spin"></i>
                </div>
                <div class="progress-ring"></div>
              </div>
              <h2 class="font-weight-bold">正在进行批量检测</h2>
              <p class="lead text-muted">系统正在处理您上传的图像，请稍候...</p>
            </div>

            <!-- 进度条 -->
            <div class="progress-container mb-5">
              <div class="progress" style="height: 35px; border-radius: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     style="width: 0%;"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100">
                  <span class="progress-text">0%</span>
                </div>
              </div>

              <!-- 进度统计 -->
              <div class="mt-4 d-flex justify-content-between">
                <div class="progress-stat">
                  <div class="stat-value" id="processed-count">0</div>
                  <div class="stat-label">已处理</div>
                </div>
                <div class="progress-stat">
                  <div class="stat-value" id="total-count">0</div>
                  <div class="stat-label">总数量</div>
                </div>
                <div class="progress-stat">
                  <div class="stat-value" id="time-elapsed">00:00</div>
                  <div class="stat-label">已用时</div>
                </div>
              </div>
            </div>

            <!-- 处理阶段 -->
            <div class="processing-stages mb-4">
              <div class="stage-item active" id="stage-1">
                <div class="stage-icon">
                  <i class="fas fa-upload"></i>
                </div>
                <div class="stage-info">
                  <h6>读取图像</h6>
                  <p class="text-muted small mb-0">正在加载图像数据...</p>
                </div>
              </div>

              <div class="stage-item" id="stage-2">
                <div class="stage-icon">
                  <i class="fas fa-brain"></i>
                </div>
                <div class="stage-info">
                  <h6>智能检测</h6>
                  <p class="text-muted small mb-0">AI模型分析中...</p>
                </div>
              </div>

              <div class="stage-item" id="stage-3">
                <div class="stage-icon">
                  <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stage-info">
                  <h6>生成报告</h6>
                  <p class="text-muted small mb-0">统计分析结果...</p>
                </div>
              </div>
            </div>

            <!-- 动态提示信息 -->
            <div class="text-center">
              <p id="progress-message" class="text-muted animated-text">
                <i class="fas fa-info-circle mr-2"></i>正在初始化检测系统...
              </p>
            </div>

            <!-- 加载动画 -->
            <div class="processing-animation text-center mt-4">
              <div class="wave-dots">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 样式 -->
  <style>
    .progress-icon-container {
      position: relative;
      display: inline-block;
    }

    .progress-icon {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
      position: relative;
      z-index: 2;
    }

    .progress-ring {
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border: 3px solid var(--accent-light);
      border-radius: 50%;
      opacity: 0.3;
      animation: pulse-ring 2s ease-out infinite;
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(1);
        opacity: 0.3;
      }
      100% {
        transform: scale(1.2);
        opacity: 0;
      }
    }

    .progress-stat {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .processing-stages {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .processing-stages::before {
      content: '';
      position: absolute;
      top: 25px;
      left: 50px;
      right: 50px;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }

    .stage-item {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
      opacity: 0.4;
      transition: all 0.3s ease;
    }

    .stage-item.active {
      opacity: 1;
    }

    .stage-item.active .stage-icon {
      background: var(--accent);
      color: white;
      transform: scale(1.1);
    }

    .stage-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #f0f0f0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      color: var(--gray);
      transition: all 0.3s ease;
    }

    .progress-text {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .animated-text {
      animation: fadeInOut 3s ease-in-out infinite;
    }

    @keyframes fadeInOut {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .wave-dots {
      display: inline-flex;
      gap: 0.5rem;
    }

    .wave-dots span {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      animation: wave 1.4s ease-in-out infinite;
    }

    .wave-dots span:nth-child(1) { animation-delay: 0s; }
    .wave-dots span:nth-child(2) { animation-delay: 0.1s; }
    .wave-dots span:nth-child(3) { animation-delay: 0.2s; }
    .wave-dots span:nth-child(4) { animation-delay: 0.3s; }
    .wave-dots span:nth-child(5) { animation-delay: 0.4s; }

    @keyframes wave {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-15px);
      }
    }
  </style>

  <!-- 脚本 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let intervalId = null;
    let startTime = Date.now();
    let currentStage = 1;

    const progressMessages = [
      "正在读取图像数据...",
      "正在进行AI模型推理...",
      "正在识别缺陷区域...",
      "正在生成可视化结果...",
      "正在统计分析数据...",
      "正在准备检测报告..."
    ];

    let messageIndex = 0;

    window.onload = function() {
      intervalId = setInterval(checkProgress, 1000);
      setInterval(updateProgressMessage, 3000);
      setInterval(updateElapsedTime, 1000);
    };

    function updateProgressMessage() {
      const messageElement = document.getElementById("progress-message");
      messageElement.style.opacity = '0';
      setTimeout(() => {
        messageElement.innerHTML = '<i class="fas fa-info-circle mr-2"></i>' + progressMessages[messageIndex];
        messageElement.style.opacity = '1';
        messageIndex = (messageIndex + 1) % progressMessages.length;
      }, 300);
    }

    function updateElapsedTime() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById("time-elapsed").textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function checkProgress() {
      fetch("{{ url_for('progress_status') }}")
        .then(res => res.json())
        .then(data => {
          const total = data.total;
          const processed = data.processed;
          const done = data.done;

          updateProgressBar(processed, total);
          updateStages(processed, total);

          document.getElementById("processed-count").textContent = processed;
          document.getElementById("total-count").textContent = total;

          if (done) {
            clearInterval(intervalId);
            document.getElementById("progress-message").innerHTML =
              '<i class="fas fa-check-circle text-success mr-2"></i>处理完成，正在跳转到结果页面...';

            // 激活最后一个阶段
            document.querySelectorAll('.stage-item').forEach(item => {
              item.classList.add('active');
            });

            setTimeout(() => {
              window.location.href = "{{ result_url }}";
            }, 1000);
          }
        })
        .catch(err => console.log(err));
    }

    function updateProgressBar(processed, total) {
      let percent = 0;
      if (total > 0) {
        percent = Math.floor((processed / total) * 100);
      }
      const bar = document.querySelector(".progress-bar");
      bar.style.width = percent + "%";
      bar.setAttribute("aria-valuenow", percent);
      bar.querySelector('.progress-text').textContent = percent + "%";
    }

    function updateStages(processed, total) {
      if (total === 0) return;

      const progress = processed / total;

      if (progress > 0 && progress <= 0.3) {
        activateStage(1);
      } else if (progress > 0.3 && progress <= 0.8) {
        activateStage(2);
      } else if (progress > 0.8) {
        activateStage(3);
      }
    }

    function activateStage(stage) {
      if (stage > currentStage) {
        currentStage = stage;
        for (let i = 1; i <= stage; i++) {
          document.getElementById(`stage-${i}`).classList.add('active');
        }
      }
    }
  </script>
</body>
</html>